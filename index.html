<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Nature Brawler - Battle Version</title>

<script src="https://cdn.jsdelivr.net/npm/phaser@3/dist/phaser.js"></script>
<script src="https://cdn.jsdelivr.net/npm/nipplejs@0.10.1/dist/nipplejs.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
body { margin:0; overflow:hidden; background:#2f8f2f; font-family: Courier; }
#joystickZone { position:fixed; bottom:20px; left:20px; width:120px; height:120px; z-index:10; }
#buttons { position:fixed; bottom:40px; right:30px; display:flex; gap:15px; z-index:10; }
.btn { width:70px; height:70px; background:rgba(0,0,0,0.7); color:white;
border-radius:50%; display:flex; justify-content:center; align-items:center;
font-weight:bold; border:2px solid #fff; }
#ui-container { position:fixed; top:10px; width:100%; display:flex;
justify-content:space-between; padding:0 20px; box-sizing:border-box; z-index:20;}
#playerCount, #connectionStatus, #killFeed {
background:rgba(0,0,0,0.5); padding:5px 10px; border-radius:5px;
}
#playerCount { color:#0f0; font-weight:bold; }
#connectionStatus { font-size:12px; color:#ff0; }
#killFeed { color:#ff4747; max-width:250px; text-align:right; }
#respawnScreen {
position:fixed; top:0; left:0; width:100%; height:100%;
background:rgba(0,0,0,0.9); display:none; flex-direction:column;
justify-content:center; align-items:center; z-index:100; color:white;
}
#respawnBtn { margin-top:20px; padding:15px 30px;
background:#e74c3c; color:white; border:none; border-radius:5px; font-weight:bold; }
</style>
</head>

<body>

<div id="ui-container">
<div>
<div id="playerCount">PLAYERS ONLINE: 1</div>
<div id="connectionStatus">Status: Connecting...</div>
</div>
<div id="killFeed">Battle Logs</div>
</div>

<div id="respawnScreen">
<h1 style="font-size:50px;color:red;">WASTED</h1>
<button id="respawnBtn">RESPAWN</button>
</div>

<div id="joystickZone"></div>
<div id="buttons">
<div id="punch" class="btn">PUNCH</div>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyBKRcUmURZwOIWTuvr66NFYr8tLq7Z9qNU",
  authDomain: "nature-brawler.firebaseapp.com",
  projectId: "nature-brawler",
  storageBucket: "nature-brawler.firebasestorage.app",
  messagingSenderId: "232369858433",
  appId: "1:232369858433:web:5228d7e2af2812c5fc2a80",
  measurementId: "G-JGFRBYTX4C"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

db.ref(".info/connected").on("value", snap=>{
const status=document.getElementById("connectionStatus");
if(snap.val()===true){
status.innerText="Status: Online ✅";
status.style.color="#0f0";
}else{
status.innerText="Status: Offline ❌";
status.style.color="red";
}
});

const charIndex=new URLSearchParams(window.location.search).get("char")||1;
let playerId="P_"+Math.random().toString(36).substr(2,4);
let player, players={}, healthBars={};
let joystickVector={x:0,y:0};
let currentAction="idle";
let isDead=false;
let lastUpdate=0;

const config={
type:Phaser.AUTO,
width:window.innerWidth,
height:window.innerHeight,
pixelArt:true,
physics:{default:"arcade",arcade:{gravity:{y:0}}},
scene:{preload,create,update}
};

const game=new Phaser.Game(config);

function preload(){
this.load.image("bg1","map.png");
["idle","run","punch","grab"].forEach(a=>{
this.load.image(`char${charIndex}_${a}`,`char${charIndex}_${a}.PNG`);
});
}

function create(){
let map=this.add.image(0,0,"bg1").setOrigin(0,0);
map.setDisplaySize(3000,3000);
this.physics.world.setBounds(0,0,3000,3000);

player=this.physics.add.image(1500,1500,`char${charIndex}_idle`);
player.setCollideWorldBounds(true);
player.setScale(0.1);
player.hp=100;

this.cameras.main.startFollow(player,true,0.1,0.1);
this.cameras.main.setZoom(2);

db.ref("players/"+playerId).set({
x:1500,y:1500,hp:100,char:charIndex,action:"idle"
});
db.ref("players/"+playerId).onDisconnect().remove();

const playersRef=db.ref("players");

playersRef.on("child_added",(snap)=>{
const id=snap.key;
const data=snap.val();
if(id===playerId)return;
players[id]=this.physics.add.image(data.x,data.y,`char${data.char}_${data.action}`);
players[id].setScale(0.1);
players[id].hp=data.hp;
});

playersRef.on("child_changed",(snap)=>{
const id=snap.key;
const data=snap.val();
if(id===playerId){
player.hp=data.hp;
if(player.hp<=0&&!isDead)triggerDeath();
return;
}
if(players[id]){
players[id].setPosition(data.x,data.y);
players[id].setTexture(`char${data.char}_${data.action}`);
players[id].hp=data.hp;
}
});

playersRef.on("child_removed",(snap)=>{
const id=snap.key;
if(players[id]){
players[id].destroy();
delete players[id];
}
});

playersRef.on("value",(snap)=>{
const data=snap.val();
document.getElementById("playerCount").innerText=
"PLAYERS ONLINE: "+(data?Object.keys(data).length:1);
});

createJoystick();

document.getElementById("punch").onmousedown=()=>playAction(this);
document.getElementById("respawnBtn").onclick=()=>respawnPlayer();
}

function update(){
if(!isDead&&(currentAction==="idle"||currentAction==="run")){
player.setVelocity(joystickVector.x*300,joystickVector.y*-300);

if(joystickVector.x!==0||joystickVector.y!==0){
if(currentAction!=="run"){
currentAction="run";
player.setTexture(`char${charIndex}_run`);
}
player.flipX=(joystickVector.x<0);
}else{
currentAction="idle";
player.setTexture(`char${charIndex}_idle`);
}
}

if(Date.now()-lastUpdate>100){
db.ref("players/"+playerId).update({
x:player.x,
y:player.y,
action:currentAction,
hp:player.hp
});
lastUpdate=Date.now();
}

updateHealthBars(this);
}

function playAction(scene){
if(isDead)return;
currentAction="punch";
player.setTexture(`char${charIndex}_punch`);

for(let id in players){
let target=players[id];
if(Phaser.Math.Distance.Between(player.x,player.y,target.x,target.y)<70){
let newHp=Math.max(0,(target.hp||100)-10);
db.ref("players/"+id).update({hp:newHp});
if(newHp===0&&target.hp>0){
db.ref("killLog").push({killer:playerId,victim:id});
}
}
}

setTimeout(()=>{
if(!isDead){
currentAction="idle";
player.setTexture(`char${charIndex}_idle`);
}
},300);
}

function triggerDeath(){
isDead=true;
player.setVelocity(0,0);
document.getElementById("respawnScreen").style.display="flex";
}

function respawnPlayer(){
isDead=false;
player.hp=100;
db.ref("players/"+playerId).update({
x:1500,y:1500,hp:100,action:"idle"
});
document.getElementById("respawnScreen").style.display="none";
}

function createJoystick(){
let manager=nipplejs.create({
zone:document.getElementById("joystickZone"),
mode:"static",
position:{left:"60px",bottom:"60px"},
color:"white"
});
manager.on("move",(evt,data)=>{
joystickVector.x=data.vector.x;
joystickVector.y=data.vector.y;
});
manager.on("end",()=>{
joystickVector.x=0;
joystickVector.y=0;
});
}

function updateHealthBars(scene){
drawBar(scene,player,playerId);
for(let id in players){
drawBar(scene,players[id],id);
}
}

function drawBar(scene,p,id){
if(!healthBars[id])healthBars[id]=scene.add.graphics();
healthBars[id].clear();
if(p.hp<=0)return;
healthBars[id].fillStyle(0x000000).fillRect(p.x-20,p.y-45,40,5);
healthBars[id].fillStyle(p.hp<30?0xff0000:0x00ff00)
.fillRect(p.x-20,p.y-45,40*(p.hp/100),5);
}
</script>
</body>
</html>

